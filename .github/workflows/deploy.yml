name: Deploy Pipeline

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '9'

jobs:
  # CI í†µê³¼ í™•ì¸
  ci-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate Prisma Client
        run: pnpm --filter @petmedi/database db:generate

      - name: Type Check
        run: |
          pnpm --filter @petmedi/api typecheck
          pnpm --filter @petmedi/web typecheck

      - name: Lint
        run: |
          pnpm --filter @petmedi/api lint
          pnpm --filter @petmedi/web lint

      - name: Test
        run: pnpm --filter @petmedi/api test --passWithNoTests
        env:
          JWT_SECRET: test-jwt-secret-for-ci
          JWT_REFRESH_SECRET: test-jwt-refresh-secret-for-ci
          DATABASE_URL: postgresql://test:test@localhost:5432/test

  # Vercel ìë™ ë°°í¬ (Web)
  # Vercelì€ GitHub ì—°ë™ ì‹œ ìë™ìœ¼ë¡œ ë°°í¬ë©ë‹ˆë‹¤
  # ì´ jobì€ ë°°í¬ ìƒíƒœë¥¼ ì¶”ì í•©ë‹ˆë‹¤
  deploy-web:
    needs: ci-check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy to Vercel
        run: |
          echo "âœ… Web deployment triggered"
          echo "Vercel automatically deploys when connected to GitHub"
          echo "Check Vercel dashboard for deployment status"

  # Render ìë™ ë°°í¬ (API)
  # Renderë„ GitHub ì—°ë™ ì‹œ ìë™ìœ¼ë¡œ ë°°í¬ë©ë‹ˆë‹¤
  deploy-api:
    needs: ci-check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Trigger Render Deploy
        run: |
          echo "âœ… API deployment triggered"
          echo "Render automatically deploys when connected to GitHub"
          echo "Check Render dashboard for deployment status"

  # ë°°í¬ ì™„ë£Œ ì•Œë¦¼
  notify:
    needs: [deploy-web, deploy-api]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Deployment Summary
        run: |
          echo "ğŸš€ Deployment Pipeline Complete"
          echo "================================"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "Author: ${{ github.actor }}"
          echo ""
          echo "ğŸ“¦ Services:"
          echo "  - Web (Vercel): Auto-deployed on push"
          echo "  - API (Render): Auto-deployed on push"
          echo "  - Database (Supabase): No deployment needed"
